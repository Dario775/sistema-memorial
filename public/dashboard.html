<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema Memorial</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div id="app">
        <!-- El contenido se cargar√° din√°micamente -->
    </div>

    <script src="/js/auth.js"></script>
    <script>
        // Verificar autenticaci√≥n
        if (!Auth.isAuthenticated()) {
            window.location.href = '/admin.html';
        }

        const funeraria = Auth.getFuneraria();
        const urlParams = new URLSearchParams(window.location.search);
        const funerariaId = urlParams.get('id');

        if (!funerariaId || (funeraria && funeraria.id !== funerariaId)) {
            window.location.href = '/admin.html';
        }

        // Cargar el dashboard
        document.getElementById('app').innerHTML = `
            <div class="header">
                <div class="container">
                    <div class="header-content">
                        <div class="logo">üïØÔ∏è ${funeraria ? funeraria.nombre : 'Dashboard'}</div>
                        <nav>
                            <ul class="nav-links">
                                <li><a href="/">Inicio</a></li>
                                <li><a href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
            
            <div class="container" style="margin-top: 40px;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Mis Eventos</h2>
                        <button onclick="showCreateEventModal()" class="btn btn-primary">
                            + Crear Evento
                        </button>
                    </div>
                    
                    <div id="eventos-alerts"></div>
                    <div id="eventos-loading" class="loading" style="display: none; margin: 20px auto;"></div>
                    <div id="eventos-list">
                        <!-- Los eventos se cargar√°n aqu√≠ -->
                    </div>
                </div>
            </div>
            
            <!-- Modal para crear/editar evento -->
            <div id="event-modal" class="modal">
                <div class="modal-content">
                    <span class="modal-close" onclick="hideEventModal()">&times;</span>
                    <h3 id="modal-title">Crear Evento</h3>
                    
                    <div id="modal-alerts"></div>
                    
                    <form id="event-form">
                        <input type="hidden" id="event-id">
                        
                        <div class="form-group">
                            <label class="form-label">Nombre del Evento:</label>
                            <input type="text" id="event-nombre" class="form-control" required placeholder="Memorial Juan P√©rez">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Frase Conmemorativa:</label>
                            <textarea id="event-frase" class="form-control" rows="3" placeholder="Con amor, te recordaremos siempre..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ID del Video de YouTube:</label>
                            <input type="text" id="event-video" class="form-control" placeholder="dQw4w9WgXcQ">
                            <small style="color: var(--text-secondary);">Solo el ID del video, no la URL completa</small>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="event-activo" checked>
                                <span>Evento activo</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="hideEventModal()" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-primary">
                                <span id="event-form-loading" class="loading" style="display: none;"></span>
                                <span id="event-form-text">Guardar</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        let eventos = [];

        // Funciones del dashboard
        function logout() {
            Auth.logout();
            window.location.href = '/admin.html';
        }

        async function loadEventos() {
            const loading = document.getElementById('eventos-loading');
            const alerts = document.getElementById('eventos-alerts');
            
            loading.style.display = 'block';
            alerts.innerHTML = '';
            
            try {
                const response = await Auth.authenticatedFetch(`/api/funerarias/${funerariaId}/eventos`);
                eventos = await response.json();
                renderEventos();
            } catch (error) {
                alerts.innerHTML = `<div class="alert alert-error">Error al cargar eventos: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderEventos() {
            const list = document.getElementById('eventos-list');
            
            if (eventos.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <h3>No tienes eventos creados</h3>
                        <p>Crea tu primer evento memorial para comenzar</p>
                    </div>
                `;
                return;
            }

            const eventosHtml = eventos.map(evento => `
                <div class="card" style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                        <div style="flex: 1;">
                            <h4>${evento.nombre}</h4>
                            <p style="color: var(--text-secondary); margin: 5px 0;">${evento.displayPhrase}</p>
                            <div style="margin: 10px 0;">
                                <span class="badge ${evento.activo ? 'badge-success' : 'badge-secondary'}">
                                    ${evento.activo ? 'Activo' : 'Inactivo'}
                                </span>
                                <span style="margin-left: 10px; font-family: monospace; background: var(--background-light); padding: 4px 8px; border-radius: 4px;">
                                    C√≥digo: ${evento.accessCode}
                                </span>
                            </div>
                            <div style="margin: 10px 0; font-size: 14px; color: var(--text-secondary);">
                                Creado: ${new Date(evento.fechaCreacion).toLocaleDateString()}
                            </div>
                            <div style="margin: 15px 0;">
                                <label style="font-weight: 600; margin-bottom: 5px; display: block; color: var(--primary-color);">üìé Link Compartible:</label>
                                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                    <input type="text" readonly class="form-control" style="flex: 1; min-width: 300px; font-size: 12px; font-family: monospace;"
                                           value="http://localhost:3000/evento/${evento.id}?code=${evento.accessCode}"
                                           id="link-${evento.id}"
                                           onclick="this.select()">
                                    <button onclick="copyLink('${evento.id}')" class="btn btn-secondary btn-sm" style="padding: 8px 12px;">
                                        üìã Copiar
                                    </button>
                                    <button onclick="shareWhatsApp('${evento.id}', '${evento.nombre.replace(/'/g, "\\'")}')" class="btn btn-success btn-sm" style="padding: 8px 12px;">
                                        üì± WhatsApp
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 120px;">
                            <a href="/evento/${evento.id}?code=${evento.accessCode}" target="_blank" class="btn btn-secondary" style="font-size: 12px;">
                                Ver Evento
                            </a>
                            <button onclick="editEvento('${evento.id}')" class="btn btn-primary" style="font-size: 12px;">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="toggleEvento('${evento.id}', ${!evento.activo})" 
                                    class="btn ${evento.activo ? 'btn-warning' : 'btn-success'}" style="font-size: 12px;">
                                ${evento.activo ? '‚è∏Ô∏è Desactivar' : '‚ñ∂Ô∏è Activar'}
                            </button>
                            <button onclick="eliminarEvento('${evento.id}')" class="btn btn-danger" style="font-size: 12px;">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            list.innerHTML = eventosHtml;
        }

        function showCreateEventModal() {
            document.getElementById('modal-title').textContent = 'Crear Evento';
            document.getElementById('event-form').reset();
            document.getElementById('event-id').value = '';
            document.getElementById('event-activo').checked = true;
            document.getElementById('event-form-text').textContent = 'Crear';
            document.getElementById('event-modal').style.display = 'block';
        }

        function editEvento(eventoId) {
            const evento = eventos.find(e => e.id === eventoId);
            if (!evento) return;

            document.getElementById('modal-title').textContent = 'Editar Evento';
            document.getElementById('event-id').value = evento.id;
            document.getElementById('event-nombre').value = evento.nombre;
            document.getElementById('event-frase').value = evento.displayPhrase;
            document.getElementById('event-video').value = evento.youtubeVideoId;
            document.getElementById('event-activo').checked = evento.activo;
            document.getElementById('event-form-text').textContent = 'Actualizar';
            document.getElementById('event-modal').style.display = 'block';
        }

        function hideEventModal() {
            document.getElementById('event-modal').style.display = 'none';
            document.getElementById('modal-alerts').innerHTML = '';
        }

        async function toggleEvento(eventoId, newStatus) {
            try {
                const response = await Auth.authenticatedFetch(
                    `/api/funerarias/${funerariaId}/eventos/${eventoId}`,
                    {
                        method: 'PUT',
                        body: JSON.stringify({ activo: newStatus })
                    }
                );

                if (response.ok) {
                    await loadEventos();
                    document.getElementById('eventos-alerts').innerHTML = 
                        `<div class="alert alert-success">Evento ${newStatus ? 'activado' : 'desactivado'} correctamente</div>`;
                }
            } catch (error) {
                document.getElementById('eventos-alerts').innerHTML = 
                    `<div class="alert alert-error">Error al actualizar evento</div>`;
            }
        }

        // Funci√≥n para copiar link al portapapeles
        function copyLink(eventoId) {
            const linkInput = document.getElementById(`link-${eventoId}`);
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                
                // Mostrar confirmaci√≥n
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ Copiado';
                button.style.background = '#28a745';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            } catch (err) {
                alert('Error al copiar el link');
            }
        }

        // Funci√≥n para compartir en WhatsApp
        function shareWhatsApp(eventoId, nombreEvento) {
            const link = document.getElementById(`link-${eventoId}`).value;
            const message = `Te invito al memorial virtual de ${nombreEvento}. 
            
Puedes acceder directamente desde este enlace:
${link}

Con amor, siempre en nuestros corazones. üïØÔ∏èüíô`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Funci√≥n para eliminar evento
        async function eliminarEvento(eventoId) {
            const evento = eventos.find(e => e.id === eventoId);
            if (!evento) return;
            
            const confirmacion = confirm(`¬øEst√°s seguro de que deseas eliminar el evento "${evento.nombre}"?
            
Esta acci√≥n no se puede deshacer y todos los datos del evento se perder√°n permanentemente.`);
            
            if (!confirmacion) return;
            
            try {
                const response = await Auth.authenticatedFetch(`/api/funerarias/${funerariaId}/eventos/${eventoId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadEventos();
                    alert('Evento eliminado exitosamente');
                } else {
                    const error = await response.json();
                    alert('Error al eliminar el evento: ' + error.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el evento');
            }
        }

        // Inicializar formulario de eventos
        document.getElementById('event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const eventId = document.getElementById('event-id').value;
            const nombre = document.getElementById('event-nombre').value;
            const displayPhrase = document.getElementById('event-frase').value;
            const youtubeVideoId = document.getElementById('event-video').value;
            const activo = document.getElementById('event-activo').checked;
            
            const loading = document.getElementById('event-form-loading');
            const alerts = document.getElementById('modal-alerts');
            
            loading.style.display = 'inline-block';
            alerts.innerHTML = '';
            
            try {
                const url = eventId 
                    ? `/api/funerarias/${funerariaId}/eventos/${eventId}`
                    : `/api/funerarias/${funerariaId}/eventos`;
                
                const method = eventId ? 'PUT' : 'POST';
                
                const response = await Auth.authenticatedFetch(url, {
                    method,
                    body: JSON.stringify({
                        nombre,
                        displayPhrase,
                        youtubeVideoId,
                        activo
                    })
                });
                
                if (response.ok) {
                    hideEventModal();
                    await loadEventos();
                    document.getElementById('eventos-alerts').innerHTML = 
                        `<div class="alert alert-success">Evento ${eventId ? 'actualizado' : 'creado'} correctamente</div>`;
                } else {
                    const data = await response.json();
                    alerts.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
                }
            } catch (error) {
                alerts.innerHTML = `<div class="alert alert-error">Error de conexi√≥n</div>`;
            } finally {
                loading.style.display = 'none';
            }
        });

        // Cargar eventos al iniciar
        loadEventos();
    </script>
</body>
</html>