<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema Memorial</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div id="app">
        <!-- El contenido se cargar√° din√°micamente -->
    </div>

    <script src="/js/auth.js"></script>
    <script>
        // Verificar autenticaci√≥n
        if (!Auth.isAuthenticated()) {
            window.location.href = '/admin.html';
        }

        const funeraria = Auth.getFuneraria();
        const urlParams = new URLSearchParams(window.location.search);
        const funerariaId = urlParams.get('id');

        if (!funerariaId || (funeraria && funeraria.id !== funerariaId)) {
            window.location.href = '/admin.html';
        }

        // Cargar el dashboard
        document.getElementById('app').innerHTML = `
            <div class="header">
                <div class="container">
                    <div class="header-content">
                        <div class="logo">üïØÔ∏è ${funeraria ? funeraria.nombre : 'Dashboard'}</div>
                        <nav>
                            <ul class="nav-links">
                                <li><a href="/">Inicio</a></li>
                                <li><a href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
            
            <div class="container" style="margin-top: 40px;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Mis Eventos</h2>
                        <button onclick="showCreateEventModal()" class="btn btn-primary">
                            + Crear Evento
                        </button>
                    </div>
                    
                    <div id="eventos-alerts"></div>
                    <div id="eventos-loading" class="loading" style="display: none; margin: 20px auto;"></div>
                    <div id="eventos-list">
                        <!-- Los eventos se cargar√°n aqu√≠ -->
                    </div>
                </div>
            </div>
            
            <!-- Modal para crear/editar evento -->
            <div id="event-modal" class="modal">
                <div class="modal-content">
                    <span class="modal-close" onclick="hideEventModal()">&times;</span>
                    <h3 id="modal-title">Crear Evento</h3>
                    
                    <div id="modal-alerts"></div>
                    
                    <form id="event-form">
                        <input type="hidden" id="event-id">
                        
                        <div class="form-group">
                            <label class="form-label">Nombre del Evento:</label>
                            <input type="text" id="event-nombre" class="form-control" required placeholder="Memorial Juan P√©rez">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Frase Conmemorativa:</label>
                            <textarea id="event-frase" class="form-control" rows="3" placeholder="Con amor, te recordaremos siempre..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ID del Video de YouTube:</label>
                            <input type="text" id="event-video" class="form-control" placeholder="dQw4w9WgXcQ">
                            <small style="color: var(--text-secondary);">Solo el ID del video, no la URL completa</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üì∏ Foto del Finado:</label>
                            <input type="file" id="event-foto" class="form-control" accept="image/*">
                            <small style="color: var(--text-secondary);">
                                Opcional - Formatos: JPG, PNG, GIF (m√°x. 5MB)<br>
                                üìè <strong>Medidas recomendadas:</strong> 400x400px o superior (formato cuadrado para mejor visualizaci√≥n)
                            </small>
                            <div id="foto-preview" style="margin-top: 10px; display: none;">
                                <img id="foto-preview-img" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color); object-fit: cover;">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="event-activo" checked>
                                <span>Evento activo</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="hideEventModal()" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-primary">
                                <span id="event-form-loading" class="loading" style="display: none;"></span>
                                <span id="event-form-text">Guardar</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        let eventos = [];

        // Funciones del dashboard
        function logout() {
            Auth.logout();
            window.location.href = '/admin.html';
        }

        async function loadEventos() {
            const loading = document.getElementById('eventos-loading');
            const alerts = document.getElementById('eventos-alerts');
            
            loading.style.display = 'block';
            alerts.innerHTML = '';
            
            try {
                const response = await Auth.authenticatedFetch(`/api/funerarias/${funerariaId}/eventos`);
                eventos = await response.json();
                renderEventos();
            } catch (error) {
                alerts.innerHTML = `<div class="alert alert-error">Error al cargar eventos: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderEventos() {
            const list = document.getElementById('eventos-list');
            
            if (eventos.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <h3>No tienes eventos creados</h3>
                        <p>Crea tu primer evento memorial para comenzar</p>
                    </div>
                `;
                return;
            }

            const eventosHtml = eventos.map(evento => `
                <div class="card" style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                        <div style="flex-shrink: 0;">
                            <img id="img-${evento.id}" src="${evento.fotoUrl ? (evento.fotoUrl.startsWith('/') ? window.location.origin + evento.fotoUrl : evento.fotoUrl) : 'https://via.placeholder.com/120?text=Foto'}" alt="Foto de ${evento.nombre}" 
                                 style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onerror="this.onerror=null;this.src='https://via.placeholder.com/120?text=Foto';">
                            <div style="font-size:12px; color:#666; margin-top:6px; max-width:120px; word-break:break-all;">${evento.fotoUrl || 'no-foto'}</div>
                        </div>
                        
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <h4 style="margin: 0;">${evento.nombre}</h4>
                                ${evento.fotoUrl ? '<span style="color: var(--success-color); font-size: 12px;">üì∏</span>' : '<span style="color: var(--text-secondary); font-size: 12px;">üì∑</span>'}
                            </div>
                            <p style="color: var(--text-secondary); margin: 5px 0;">${evento.displayPhrase}</p>
                            <div style="margin: 10px 0;">
                                <span class="badge ${evento.activo ? 'badge-success' : 'badge-secondary'}">
                                    ${evento.activo ? 'Activo' : 'Inactivo'}
                                </span>
                                <span style="margin-left: 10px; font-family: monospace; background: var(--background-light); padding: 4px 8px; border-radius: 4px;">
                                    C√≥digo: ${evento.accessCode}
                                </span>
                            </div>
                            <div style="margin: 10px 0; font-size: 14px; color: var(--text-secondary);">
                                Creado: ${new Date(evento.fechaCreacion).toLocaleDateString()}
                            </div>
                            <div style="margin: 15px 0;">
                                <label style="font-weight: 600; margin-bottom: 5px; display: block; color: var(--primary-color);">üìé Link Compartible:</label>
                                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                    <input type="text" readonly class="form-control" style="flex: 1; min-width: 300px; font-size: 12px; font-family: monospace;"
                                           value="${window.location.origin}/evento/${evento.id}?code=${evento.accessCode}"
                                           id="link-${evento.id}"
                                           onclick="this.select()">
                                    <button onclick="copyLink('${evento.id}')" class="btn btn-secondary btn-sm" style="padding: 8px 12px;">
                                        üìã Copiar
                                    </button>
                                    <button onclick="shareWhatsApp('${evento.id}', '${evento.nombre.replace(/'/g, "\\'")}')" class="btn btn-success btn-sm" style="padding: 8px 12px;">
                                        üì± WhatsApp
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 120px;">
                            <a href="/evento/${evento.id}?code=${evento.accessCode}" target="_blank" class="btn btn-secondary" style="font-size: 12px;">
                                Ver Evento
                            </a>
                            <button onclick="editEvento('${evento.id}')" class="btn btn-primary" style="font-size: 12px;">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="toggleEvento('${evento.id}', ${!evento.activo})" 
                                    class="btn ${evento.activo ? 'btn-warning' : 'btn-success'}" style="font-size: 12px;">
                                ${evento.activo ? '‚è∏Ô∏è Desactivar' : '‚ñ∂Ô∏è Activar'}
                            </button>
                            <button onclick="eliminarEvento('${evento.id}')" class="btn btn-danger" style="font-size: 12px;">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            list.innerHTML = eventosHtml;
        }

        function showCreateEventModal() {
            document.getElementById('modal-title').textContent = 'Crear Evento';
            document.getElementById('event-form').reset();
            document.getElementById('event-id').value = '';
            document.getElementById('event-activo').checked = true;
            document.getElementById('event-form-text').textContent = 'Crear';
            // Limpiar preview de foto
            document.getElementById('foto-preview').style.display = 'none';
            document.getElementById('event-foto').value = '';
            document.getElementById('event-modal').style.display = 'block';
        }

        function editEvento(eventoId) {
            const evento = eventos.find(e => e.id === eventoId);
            if (!evento) return;

            document.getElementById('modal-title').textContent = 'Editar Evento';
            document.getElementById('event-id').value = evento.id;
            document.getElementById('event-nombre').value = evento.nombre;
            document.getElementById('event-frase').value = evento.displayPhrase;
            document.getElementById('event-video').value = evento.youtubeVideoId;
            document.getElementById('event-activo').checked = evento.activo;
            document.getElementById('event-form-text').textContent = 'Actualizar';
            document.getElementById('event-modal').style.display = 'block';
        }

        function hideEventModal() {
            document.getElementById('event-modal').style.display = 'none';
            document.getElementById('modal-alerts').innerHTML = '';
            // Limpiar preview de foto
            document.getElementById('foto-preview').style.display = 'none';
            document.getElementById('event-foto').value = '';
        }

        async function toggleEvento(eventoId, newStatus) {
            try {
                const response = await Auth.authenticatedFetch(
                    `/api/funerarias/${funerariaId}/eventos/${eventoId}`,
                    {
                        method: 'PUT',
                        body: JSON.stringify({ activo: newStatus })
                    }
                );

                if (response.ok) {
                    await loadEventos();
                    document.getElementById('eventos-alerts').innerHTML = 
                        `<div class="alert alert-success">Evento ${newStatus ? 'activado' : 'desactivado'} correctamente</div>`;
                }
            } catch (error) {
                document.getElementById('eventos-alerts').innerHTML = 
                    `<div class="alert alert-error">Error al actualizar evento</div>`;
            }
        }

        // Funci√≥n para copiar link al portapapeles
        function copyLink(eventoId) {
            const linkInput = document.getElementById(`link-${eventoId}`);
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                
                // Mostrar confirmaci√≥n
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ Copiado';
                button.style.background = '#28a745';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            } catch (err) {
                alert('Error al copiar el link');
            }
        }

        // Funci√≥n para compartir en WhatsApp
        function shareWhatsApp(eventoId, nombreEvento) {
            const link = document.getElementById(`link-${eventoId}`).value;
            const message = `Te invito al memorial virtual de ${nombreEvento}. 
            
Puedes acceder directamente desde este enlace:
${link}

Con amor, siempre en nuestros corazones. üïØÔ∏èüíô`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Funci√≥n para eliminar evento
        async function eliminarEvento(eventoId) {
            const evento = eventos.find(e => e.id === eventoId);
            if (!evento) return;
            
            const confirmacion = confirm(`¬øEst√°s seguro de que deseas eliminar el evento "${evento.nombre}"?
            
Esta acci√≥n no se puede deshacer y todos los datos del evento se perder√°n permanentemente.`);
            
            if (!confirmacion) return;
            
            try {
                const response = await Auth.authenticatedFetch(`/api/funerarias/${funerariaId}/eventos/${eventoId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadEventos();
                    alert('Evento eliminado exitosamente');
                } else {
                    const error = await response.json();
                    alert('Error al eliminar el evento: ' + error.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el evento');
            }
        }

        // Inicializar formulario de eventos
        document.getElementById('event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const eventId = document.getElementById('event-id').value;
            const nombre = document.getElementById('event-nombre').value;
            const displayPhrase = document.getElementById('event-frase').value;
            const youtubeVideoId = document.getElementById('event-video').value;
            const activo = document.getElementById('event-activo').checked;
            const fotoFile = document.getElementById('event-foto').files[0];
            
            const loading = document.getElementById('event-form-loading');
            const alerts = document.getElementById('modal-alerts');
            
            loading.style.display = 'inline-block';
            alerts.innerHTML = '';
            
            try {
                // Primero crear/actualizar el evento
                const url = eventId 
                    ? `/api/funerarias/${funerariaId}/eventos/${eventId}`
                    : `/api/funerarias/${funerariaId}/eventos`;
                
                const method = eventId ? 'PUT' : 'POST';
                
                const response = await Auth.authenticatedFetch(url, {
                    method,
                    body: JSON.stringify({
                        nombre,
                        displayPhrase,
                        youtubeVideoId,
                        activo
                    })
                });
                
                if (response.ok) {
                    const eventoData = await response.json();
                    const finalEventId = eventId || eventoData.id;
                    
                    // Si hay una foto, subirla
                    if (fotoFile) {
                        try {
                            const uploadedUrl = await subirFotoEvento(finalEventId, fotoFile);
                            // Actualizar la imagen en la lista inmediatamente
                            const imgEl = document.getElementById(`img-${finalEventId}`);
                            if (imgEl) {
                                imgEl.src = uploadedUrl.startsWith('/') ? window.location.origin + uploadedUrl : uploadedUrl;
                                // actualizar el texto de debug si existe
                                const debugDiv = imgEl.nextElementSibling;
                                if (debugDiv) debugDiv.textContent = uploadedUrl;
                            }
                            alerts.innerHTML = `<div class="alert alert-success">Evento y foto ${eventId ? 'actualizados' : 'creados'} correctamente</div>`;
                        } catch (fotoError) {
                            alerts.innerHTML = `<div class="alert alert-warning">Evento ${eventId ? 'actualizado' : 'creado'} correctamente, pero hubo un error al subir la foto: ${fotoError.message}</div>`;
                        }
                    } else {
                        alerts.innerHTML = `<div class="alert alert-success">Evento ${eventId ? 'actualizado' : 'creado'} correctamente</div>`;
                    }
                    
                    hideEventModal();
                    await loadEventos();
                    document.getElementById('eventos-alerts').innerHTML = alerts.innerHTML;
                } else {
                    const data = await response.json();
                    alerts.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
                }
            } catch (error) {
                alerts.innerHTML = `<div class="alert alert-error">Error de conexi√≥n: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        });

        // Funcionalidad para preview de foto
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'event-foto') {
                const file = e.target.files[0];
                const preview = document.getElementById('foto-preview');
                const previewImg = document.getElementById('foto-preview-img');
                
                if (file) {
                    // Validar tama√±o (5MB m√°ximo)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('La imagen es demasiado grande. El tama√±o m√°ximo es 5MB.');
                        e.target.value = '';
                        preview.style.display = 'none';
                        return;
                    }
                    
                    // Mostrar preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                }
            }
        });

        // Funci√≥n para subir foto de evento
        async function subirFotoEvento(eventoId, file) {
            console.log('üîç Iniciando subida de foto:', {
                eventoId,
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type
            });
            
            const formData = new FormData();
            formData.append('foto', file);
            
            const uploadUrl = `/api/funerarias/${funerariaId}/eventos/${eventoId}/foto`;
            console.log('üì§ URL de subida:', uploadUrl);
            
            try {
                const response = await Auth.authenticatedFetch(uploadUrl, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('üì° Respuesta del servidor:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Foto subida exitosamente:', result);
                    return result.fotoUrl;
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error del servidor:', errorText);
                    throw new Error(errorText || 'Error al subir la foto');
                }
            } catch (error) {
                console.error('üí• Error al subir foto:', error);
                throw error;
            }
        }

        // Cargar eventos al iniciar
        loadEventos();
    </script>
</body>
</html>